# AI-SDLC Pipeline for isA Platform
# Automated CDD + TDD + Deployment workflow

name: AI-SDLC Pipeline

on:
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to process (e.g., memory, account, session)'
        required: true
        type: string
      mode:
        description: 'Pipeline mode'
        required: true
        default: 'full'
        type: choice
        options:
          - full      # CDD + TDD + Deploy
          - cdd       # CDD layers only (1-6)
          - tdd       # TDD only (run tests)
          - deploy    # Deploy only
          - validate  # Validate existing artifacts
      version:
        description: 'Version tag for deployment (e.g., v1.0.0)'
        required: false
        default: 'latest'
        type: string
      dry_run:
        description: 'Dry run (no actual changes)'
        required: false
        default: false
        type: boolean

  # Trigger on PR to main for validation
  pull_request:
    branches: [main, release/*]
    paths:
      - 'microservices/**'
      - 'tests/**'
      - 'docs/domain/**'
      - 'docs/prd/**'
      - 'docs/design/**'

env:
  PYTHON_VERSION: '3.11'
  KIND_CLUSTER_NAME: 'isa-cloud-local'
  K8S_NAMESPACE: 'isa-cloud-staging'

jobs:
  # =============================================================================
  # Stage 1: Validate CDD Artifacts
  # =============================================================================
  validate-cdd:
    name: Validate CDD Layers
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.mode != 'deploy' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install Dependencies
        run: |
          pip install -r deployment/requirements/dev.txt

      - name: Validate Domain Context (Layer 1)
        if: ${{ github.event.inputs.mode == 'full' || github.event.inputs.mode == 'cdd' || github.event.inputs.mode == 'validate' }}
        run: |
          python -c "
          from agents.validators import DomainValidator
          validator = DomainValidator()
          report = validator.validate_file('docs/domain/${{ github.event.inputs.service }}_service.md')
          print(report.to_summary())
          if not report.is_valid:
              exit(1)
          "

      - name: Validate PRD (Layer 2)
        if: ${{ github.event.inputs.mode == 'full' || github.event.inputs.mode == 'cdd' || github.event.inputs.mode == 'validate' }}
        run: |
          python -c "
          from agents.validators import PRDValidator
          validator = PRDValidator()
          report = validator.validate_file('docs/prd/${{ github.event.inputs.service }}_service.md')
          print(report.to_summary())
          if not report.is_valid:
              exit(1)
          "

      - name: Validate Design (Layer 3)
        if: ${{ github.event.inputs.mode == 'full' || github.event.inputs.mode == 'cdd' || github.event.inputs.mode == 'validate' }}
        run: |
          python -c "
          from agents.validators import DesignValidator
          validator = DesignValidator()
          report = validator.validate_file('docs/design/${{ github.event.inputs.service }}_service.md')
          print(report.to_summary())
          if not report.is_valid:
              exit(1)
          "

      - name: Validate Contracts (Layers 4-6)
        if: ${{ github.event.inputs.mode == 'full' || github.event.inputs.mode == 'cdd' || github.event.inputs.mode == 'validate' }}
        run: |
          python -c "
          from agents.validators import ContractValidator
          validator = ContractValidator()
          report = validator.validate_service('${{ github.event.inputs.service }}')
          print(report.to_summary())
          if not report.is_valid:
              exit(1)
          "

  # =============================================================================
  # Stage 2: Run Test Pyramid
  # =============================================================================
  test-pyramid:
    name: Run Test Pyramid
    runs-on: ubuntu-latest
    needs: [validate-cdd]
    if: ${{ github.event.inputs.mode != 'deploy' && github.event.inputs.mode != 'cdd' }}

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: isa_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      nats:
        image: nats:2.10
        ports:
          - 4222:4222
        options: >-
          --health-cmd "wget -q --spider http://localhost:8222/healthz || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install Dependencies
        run: |
          pip install -r deployment/requirements/dev.txt

      - name: Run Unit Tests
        run: |
          pytest tests/unit/${{ github.event.inputs.service }}/ \
            -v --tb=short \
            --junitxml=reports/unit-results.xml \
            --cov=microservices/${{ github.event.inputs.service }}_service \
            --cov-report=xml:reports/coverage-unit.xml

      - name: Run Component Tests
        run: |
          pytest tests/component/${{ github.event.inputs.service }}/ \
            -v --tb=short \
            --junitxml=reports/component-results.xml

      - name: Run Golden Tests
        if: ${{ github.event.inputs.mode == 'tdd' || github.event.inputs.mode == 'full' }}
        run: |
          pytest tests/unit/golden/${{ github.event.inputs.service }}_service/ \
            -v --tb=short \
            --junitxml=reports/golden-results.xml

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: reports/

  # =============================================================================
  # Stage 3: Build Docker Image
  # =============================================================================
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [test-pyramid]
    if: ${{ github.event.inputs.mode == 'full' || github.event.inputs.mode == 'deploy' }}
    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Docker Meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: isa/${{ github.event.inputs.service }}
          tags: |
            type=raw,value=${{ github.event.inputs.version }}
            type=sha,prefix=

      - name: Build Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: deployment/k8s/Dockerfile.microservice
          build-args: |
            SERVICE_NAME=${{ github.event.inputs.service }}_service
          push: false
          load: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Save Image
        if: ${{ !github.event.inputs.dry_run }}
        run: |
          docker save isa/${{ github.event.inputs.service }}:${{ github.event.inputs.version }} \
            -o /tmp/image.tar

      - name: Upload Image Artifact
        if: ${{ !github.event.inputs.dry_run }}
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: /tmp/image.tar
          retention-days: 1

  # =============================================================================
  # Stage 4: Deploy to K8s
  # =============================================================================
  deploy:
    name: Deploy to K8s
    runs-on: ubuntu-latest
    needs: [build]
    if: ${{ (github.event.inputs.mode == 'full' || github.event.inputs.mode == 'deploy') && !github.event.inputs.dry_run }}
    environment: staging

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Image
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: /tmp

      - name: Setup Kind
        uses: helm/kind-action@v1
        with:
          cluster_name: ${{ env.KIND_CLUSTER_NAME }}

      - name: Load Image to Kind
        run: |
          docker load -i /tmp/image.tar
          kind load docker-image isa/${{ github.event.inputs.service }}:${{ github.event.inputs.version }} \
            --name ${{ env.KIND_CLUSTER_NAME }}

      - name: Deploy to Staging
        run: |
          kubectl set image deployment/${{ github.event.inputs.service }} \
            ${{ github.event.inputs.service }}=isa/${{ github.event.inputs.service }}:${{ github.event.inputs.version }} \
            -n ${{ env.K8S_NAMESPACE }}

          kubectl rollout status deployment/${{ github.event.inputs.service }} \
            -n ${{ env.K8S_NAMESPACE }} \
            --timeout=120s

      - name: Health Check
        run: |
          sleep 10
          kubectl port-forward -n ${{ env.K8S_NAMESPACE }} \
            svc/${{ github.event.inputs.service }} 8080:8080 &
          sleep 5
          curl -f http://localhost:8080/health || exit 1

  # =============================================================================
  # Stage 5: Integration & API Tests
  # =============================================================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [deploy]
    if: ${{ github.event.inputs.mode == 'full' && !github.event.inputs.dry_run }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Dependencies
        run: |
          pip install -r deployment/requirements/dev.txt

      - name: Setup Port Forwards
        run: |
          # Port forward infrastructure
          kubectl port-forward -n ${{ env.K8S_NAMESPACE }} svc/isa-postgres-grpc 50061:50061 &
          kubectl port-forward -n ${{ env.K8S_NAMESPACE }} svc/nats 4222:4222 &
          kubectl port-forward -n ${{ env.K8S_NAMESPACE }} svc/${{ github.event.inputs.service }} 8080:8080 &
          sleep 10

      - name: Run Integration Tests
        env:
          SERVICE_URL: http://localhost:8080
          POSTGRES_GRPC_HOST: localhost
          POSTGRES_GRPC_PORT: 50061
          NATS_URL: nats://localhost:4222
        run: |
          pytest tests/integration/${{ github.event.inputs.service }}/ \
            -v --tb=short \
            --junitxml=reports/integration-results.xml

      - name: Run API Tests
        env:
          SERVICE_URL: http://localhost:8080
        run: |
          pytest tests/api/${{ github.event.inputs.service }}/ \
            -v --tb=short \
            --junitxml=reports/api-results.xml

      - name: Upload Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-results
          path: reports/

  # =============================================================================
  # Stage 6: Smoke Tests
  # =============================================================================
  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    needs: [integration-tests]
    if: ${{ github.event.inputs.mode == 'full' && !github.event.inputs.dry_run }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Smoke Tests
        run: |
          kubectl port-forward -n ${{ env.K8S_NAMESPACE }} \
            svc/apisix-gateway 8000:8000 &
          sleep 5

          # Run smoke tests via gateway
          for script in tests/smoke/${{ github.event.inputs.service }}/*.sh; do
            if [ -f "$script" ]; then
              echo "Running: $script"
              bash "$script" || exit 1
            fi
          done

  # =============================================================================
  # Summary Report
  # =============================================================================
  summary:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    needs: [validate-cdd, test-pyramid, build, deploy, integration-tests, smoke-tests]
    if: always()

    steps:
      - name: Download All Results
        uses: actions/download-artifact@v4
        with:
          path: all-results

      - name: Generate Summary
        run: |
          echo "# AI-SDLC Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Service: ${{ github.event.inputs.service }}" >> $GITHUB_STEP_SUMMARY
          echo "## Mode: ${{ github.event.inputs.mode }}" >> $GITHUB_STEP_SUMMARY
          echo "## Version: ${{ github.event.inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| CDD Validation | ${{ needs.validate-cdd.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test Pyramid | ${{ needs.test-pyramid.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| K8s Deploy | ${{ needs.deploy.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Tests | ${{ needs.integration-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Smoke Tests | ${{ needs.smoke-tests.result }} |" >> $GITHUB_STEP_SUMMARY
