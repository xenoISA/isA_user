# è®¡è´¹æµç¨‹å®Œæ•´æ¶æ„æ–‡æ¡£

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜ isA å¹³å°çš„è®¡è´¹ç³»ç»Ÿæ¶æ„ï¼ŒåŒ…æ‹¬äº‹ä»¶é©±åŠ¨æµç¨‹ã€æœåŠ¡èŒè´£å’Œæ•°æ®æµã€‚

## ğŸ—ï¸ æ¶æ„ç»„ä»¶

### 1. æ ¸å¿ƒæœåŠ¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    è®¡è´¹ç”Ÿæ€ç³»ç»Ÿ                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚isA_Model â”‚      â”‚isA_MCP   â”‚      â”‚storage   â”‚         â”‚
â”‚  â”‚(AIæ¨ç†)  â”‚      â”‚(å·¥å…·è°ƒç”¨)â”‚      â”‚(å­˜å‚¨)    â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜         â”‚
â”‚       â”‚                 â”‚                  â”‚                â”‚
â”‚       â”‚  usage.recorded äº‹ä»¶                â”‚                â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                         â†“                                   â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚              â”‚   NATS Event Bus     â”‚                       â”‚
â”‚              â”‚  (äº‹ä»¶æ€»çº¿)          â”‚                       â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                         â†“                                   â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚              â”‚  billing_service     â”‚                       â”‚
â”‚              â”‚  (è®¡è´¹æœåŠ¡)          â”‚                       â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                         â”‚                                   â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚           â”‚             â”‚             â”‚                     â”‚
â”‚           â†“             â†“             â†“                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚   â”‚product   â”‚  â”‚wallet    â”‚  â”‚è®¢é˜…      â”‚                â”‚
â”‚   â”‚_service  â”‚  â”‚_service  â”‚  â”‚ç®¡ç†      â”‚                â”‚
â”‚   â”‚(å®šä»·)    â”‚  â”‚(æ‰£è´¹)    â”‚  â”‚          â”‚                â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. äº‹ä»¶å¥‘çº¦å±‚ (isa_common)

```python
# isa_common/events/billing_events.py

äº‹ä»¶ç±»å‹ï¼š
â”œâ”€â”€ usage.recorded          # ä½¿ç”¨è®°å½•äº‹ä»¶ï¼ˆæºï¼šisA_Model/MCP/storageï¼‰
â”œâ”€â”€ billing.calculated      # è®¡è´¹è®¡ç®—å®Œæˆï¼ˆæºï¼šbilling_serviceï¼‰
â”œâ”€â”€ wallet.tokens.deducted  # Tokenæ‰£è´¹å®Œæˆï¼ˆæºï¼šwallet_serviceï¼‰
â””â”€â”€ wallet.tokens.insufficient # ä½™é¢ä¸è¶³ï¼ˆæºï¼šwallet_serviceï¼‰
```

## ğŸ”„ å®Œæ•´è®¡è´¹æµç¨‹

### æµç¨‹ 1: AI æ¨¡å‹è°ƒç”¨è®¡è´¹

```
ç”¨æˆ·è°ƒç”¨ GPT-4
    â†“
1. isA_Model æ‰§è¡Œæ¨ç†
   â”œâ”€ è°ƒç”¨ OpenAI API
   â”œâ”€ è·å– token ä½¿ç”¨é‡: {input: 100, output: 200}
   â””â”€ å‘å¸ƒäº‹ä»¶åˆ° NATS
   
2. å‘å¸ƒ usage.recorded äº‹ä»¶
   NATS Subject: usage.recorded.gpt-4
   Event Data: {
     "user_id": "usr_123",
     "product_id": "gpt-4",
     "usage_amount": 300,
     "unit_type": "token",
     "usage_details": {
       "input_tokens": 100,
       "output_tokens": 200,
       "provider": "openai",
       "model": "gpt-4",
       "operation": "chat"
     }
   }
   
3. billing_service ç›‘å¬å¹¶å¤„ç†
   â”œâ”€ è°ƒç”¨ product_service è·å–å®šä»·
   â”‚  GET /api/v1/product/products/gpt-4/pricing
   â”‚  Response: {
   â”‚    "unit_price": 0.00003,  # $0.03 / 1000 tokens
   â”‚    "free_tier_included": 0,
   â”‚    "subscription_included": 10000
   â”‚  }
   â”œâ”€ è®¡ç®—æˆæœ¬
   â”‚  cost_usd = 300 * 0.00003 = $0.009
   â”‚  token_equivalent = 300 tokens
   â”œâ”€ æ£€æŸ¥è®¢é˜…åŒ…å«é¢åº¦
   â”‚  if subscription_plan == "pro":
   â”‚    å·²ä½¿ç”¨ 5000/10000 (è¿˜å‰© 5000)
   â”‚    æœ¬æ¬¡ä½¿ç”¨ 300ï¼Œä»è®¢é˜…é¢åº¦æ‰£é™¤
   â”‚    is_included_in_subscription = true
   â”‚    cost_usd = 0
   â”œâ”€ åˆ›å»ºè®¡è´¹è®°å½•
   â”‚  INSERT INTO billing_records ...
   â””â”€ å‘å¸ƒ billing.calculated äº‹ä»¶
   
4. å‘å¸ƒ billing.calculated äº‹ä»¶
   NATS Subject: billing.calculated
   Event Data: {
     "user_id": "usr_123",
     "billing_record_id": "bill_456",
     "usage_event_id": "evt_789",
     "product_id": "gpt-4",
     "actual_usage": 300,
     "unit_type": "token",
     "token_equivalent": 300,
     "cost_usd": 0,
     "is_free_tier": false,
     "is_included_in_subscription": true
   }
   
5. wallet_service ç›‘å¬å¹¶å¤„ç†
   â”œâ”€ æ£€æŸ¥è®¡è´¹ç±»å‹
   â”‚  if is_included_in_subscription:
   â”‚    æ›´æ–°è®¢é˜…ä½¿ç”¨é‡ç»Ÿè®¡
   â”‚    ä¸æ‰£é™¤é’±åŒ…ä½™é¢
   â”‚  else if is_free_tier:
   â”‚    æ›´æ–°å…è´¹é¢åº¦ä½¿ç”¨é‡
   â”‚  else:
   â”‚    éœ€è¦æ‰£é™¤ token
   â”‚    token_to_deduct = token_equivalent = 300
   â”œâ”€ è·å–ç”¨æˆ·é’±åŒ…
   â”‚  SELECT * FROM wallets WHERE user_id = 'usr_123'
   â”‚  balance_before = 10000 tokens
   â”œâ”€ æ‰£é™¤ token
   â”‚  balance_after = 10000 - 300 = 9700
   â”‚  UPDATE wallets SET balance = 9700
   â”œâ”€ åˆ›å»ºäº¤æ˜“è®°å½•
   â”‚  INSERT INTO transactions ...
   â””â”€ å‘å¸ƒæ‰£è´¹äº‹ä»¶
   
6. å‘å¸ƒ wallet.tokens.deducted äº‹ä»¶
   NATS Subject: wallet.tokens.deducted
   Event Data: {
     "user_id": "usr_123",
     "billing_record_id": "bill_456",
     "transaction_id": "txn_111",
     "tokens_deducted": 300,
     "balance_before": 10000,
     "balance_after": 9700,
     "monthly_quota": 100000,
     "monthly_used": 25300,
     "percentage_used": 25.3
   }
```

### æµç¨‹ 2: ä½™é¢ä¸è¶³å¤„ç†

```
ç”¨æˆ·è°ƒç”¨ API (ä½™é¢: 100 tokens)
    â†“
1-3. [åŒä¸Šï¼Œè®¡ç®—å‡ºéœ€è¦ 500 tokens]
    â†“
4. wallet_service æ£€æŸ¥ä½™é¢
   â”œâ”€ balance_available = 100 tokens
   â”œâ”€ tokens_required = 500 tokens
   â”œâ”€ tokens_deficit = 400 tokens
   â””â”€ ä½™é¢ä¸è¶³ï¼
   
5. å‘å¸ƒ wallet.tokens.insufficient äº‹ä»¶
   NATS Subject: wallet.tokens.insufficient
   Event Data: {
     "user_id": "usr_123",
     "billing_record_id": "bill_456",
     "tokens_required": 500,
     "tokens_available": 100,
     "tokens_deficit": 400,
     "suggested_action": "upgrade_plan"
   }
   
6. notification_service ç›‘å¬å¹¶é€šçŸ¥ç”¨æˆ·
   â”œâ”€ å‘é€é‚®ä»¶: "æ‚¨çš„ä½™é¢ä¸è¶³ï¼Œè¯·å……å€¼æˆ–å‡çº§å¥—é¤"
   â””â”€ æ¨é€é€šçŸ¥åˆ°å®¢æˆ·ç«¯
   
7. billing_service ç›‘å¬å¹¶æ ‡è®°å¤±è´¥
   â”œâ”€ UPDATE billing_records 
   â”‚  SET status = 'insufficient_balance'
   â””â”€ å¯é€‰ï¼šå›æ»š isA_Model çš„è°ƒç”¨ï¼ˆå–å†³äºä¸šåŠ¡è§„åˆ™ï¼‰
```

### æµç¨‹ 3: MCP å·¥å…·è°ƒç”¨è®¡è´¹

```
ç”¨æˆ·è°ƒç”¨ MCP å·¥å…· (web_search)
    â†“
1. isA_MCP æ‰§è¡Œå·¥å…·
   â”œâ”€ è°ƒç”¨ Google Search API
   â”œâ”€ å¯èƒ½è°ƒç”¨ LLM å¤„ç†ç»“æœ
   â””â”€ å‘å¸ƒäº‹ä»¶
   
2. å‘å¸ƒ usage.recorded äº‹ä»¶
   NATS Subject: usage.recorded.mcp-tool-web-search
   Event Data: {
     "user_id": "usr_123",
     "product_id": "mcp-tool-web-search",
     "usage_amount": 1,
     "unit_type": "request",
     "usage_details": {
       "tool_name": "web_search",
       "query": "latest AI news",
       "model_cost_usd": 0.0015,  # å¦‚æœè°ƒç”¨äº† LLM
       "model_tokens": 500,
       "model_product": "gpt-4"
     }
   }
   
3. billing_service å¤„ç†
   â”œâ”€ è·å–å·¥å…·å®šä»·: $0.01/request
   â”œâ”€ è®¡ç®— LLM æˆæœ¬: $0.0015
   â”œâ”€ æ€»æˆæœ¬: $0.0115
   â”œâ”€ Token ç­‰ä»·å€¼: $0.0115 / $0.00003 â‰ˆ 383 tokens
   â””â”€ å‘å¸ƒ billing.calculated
   
4-6. [åŒ AI æ¨¡å‹æµç¨‹]
```

### æµç¨‹ 4: å­˜å‚¨ç©ºé—´ä½¿ç”¨è®¡è´¹

```
ç”¨æˆ·ä¸Šä¼  100MB æ–‡ä»¶
    â†“
1. storage_service å¤„ç†ä¸Šä¼ 
   â”œâ”€ ä¸Šä¼ åˆ° MinIO
   â”œâ”€ åˆ›å»ºæ–‡ä»¶è®°å½•
   â””â”€ å‘å¸ƒäº‹ä»¶
   
2. å‘å¸ƒ usage.recorded äº‹ä»¶
   NATS Subject: usage.recorded.storage-minio
   Event Data: {
     "user_id": "usr_123",
     "product_id": "storage-minio",
     "usage_amount": 104857600,  # 100MB in bytes
     "unit_type": "byte",
     "usage_details": {
       "file_id": "file_789",
       "file_size": 104857600,
       "storage_class": "STANDARD",
       "operation": "upload"
     }
   }
   
3. billing_service å¤„ç†
   â”œâ”€ è·å–å­˜å‚¨å®šä»·: $0.02/GB/month
   â”œâ”€ è½¬æ¢: 100MB = 0.1GB
   â”œâ”€ æŒ‰å°æ—¶è®¡è´¹: $0.02 / 30 / 24 â‰ˆ $0.0000278/hour
   â”œâ”€ Token ç­‰ä»·å€¼: çº¦ 0.93 tokens/hour
   â””â”€ æ¯å°æ—¶æ‰£è´¹ä¸€æ¬¡
```

## ğŸ’° å®šä»·ç­–ç•¥

### Token è½¬æ¢ç‡

```
åŸºå‡†: 1 token = $0.00003 (åŸºäº GPT-4 å®šä»·)

æ‰€æœ‰è®¡è´¹æœ€ç»ˆè½¬æ¢ä¸º token ç­‰ä»·å€¼ï¼Œä¾¿äºç»Ÿä¸€é’±åŒ…æ‰£è´¹ã€‚
```

### äº§å“å®šä»·

| äº§å“ | å•ä»· | å•ä½ | Token ç­‰ä»·å€¼ |
|------|------|------|--------------|
| GPT-4 | $0.03 / 1K | token | 1:1 |
| GPT-3.5 | $0.001 / 1K | token | 1:1 |
| DALL-E 3 | $0.04 | image | 1333 tokens/image |
| Whisper | $0.006 / min | minute | 200 tokens/min |
| MCP Web Search | $0.01 | request | 333 tokens/request |
| MinIO Storage | $0.02 / GB/month | byte | ~0.93 tokens/GB/hour |
| Qdrant Storage | $0.05 / GB/month | byte | ~2.3 tokens/GB/hour |

### è®¢é˜…è®¡åˆ’

| è®¡åˆ’ | æœˆè´¹ | åŒ…å« Token | æŠ˜æ‰£ |
|------|------|-----------|------|
| Free | $0 | 10,000 | - |
| Starter | $20 | 100,000 | 33% off |
| Pro | $100 | 1,000,000 | 67% off |
| Enterprise | å®šåˆ¶ | å®šåˆ¶ | å®šåˆ¶ |

### è®¡è´¹ä¼˜å…ˆçº§

```
1. å…è´¹å¥—é¤é¢åº¦ (Free Tier)
   â†“ (ç”¨å®Œå)
2. è®¢é˜…åŒ…å«é¢åº¦ (Subscription Included)
   â†“ (ç”¨å®Œå)
3. é’±åŒ…ä½™é¢æ‰£è´¹ (Pay-as-you-go)
   â†“ (ä½™é¢ä¸è¶³)
4. æ‹’ç»æœåŠ¡å¹¶é€šçŸ¥ç”¨æˆ·
```

## ğŸ“Š æ•°æ®æ¨¡å‹

### billing_records è¡¨

```sql
CREATE TABLE billing_records (
    billing_record_id VARCHAR(64) PRIMARY KEY,
    user_id VARCHAR(64) NOT NULL,
    organization_id VARCHAR(64),
    
    -- äº§å“ä¿¡æ¯
    product_id VARCHAR(128) NOT NULL,
    product_category VARCHAR(64),
    
    -- ä½¿ç”¨é‡
    usage_amount DECIMAL(20, 6) NOT NULL,
    unit_type VARCHAR(32) NOT NULL,  -- token, image, minute, request, byte
    
    -- æˆæœ¬è®¡ç®—
    unit_price DECIMAL(10, 6),
    cost_usd DECIMAL(10, 6),
    token_equivalent DECIMAL(20, 2),
    
    -- è®¡è´¹åˆ†ç±»
    is_free_tier BOOLEAN DEFAULT false,
    is_included_in_subscription BOOLEAN DEFAULT false,
    subscription_id VARCHAR(64),
    
    -- çŠ¶æ€
    status VARCHAR(32) DEFAULT 'pending',  -- pending, completed, failed, insufficient_balance
    
    -- å…ƒæ•°æ®
    usage_details JSONB,
    usage_event_id VARCHAR(64),
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    processed_at TIMESTAMP WITH TIME ZONE,
    
    INDEX idx_user_created (user_id, created_at DESC),
    INDEX idx_product_created (product_id, created_at DESC),
    INDEX idx_status (status)
);
```

### wallet transactions è¡¨

```sql
CREATE TABLE transactions (
    transaction_id VARCHAR(64) PRIMARY KEY,
    wallet_id VARCHAR(64) NOT NULL,
    user_id VARCHAR(64) NOT NULL,
    
    -- äº¤æ˜“ç±»å‹
    transaction_type VARCHAR(32) NOT NULL,  -- debit, credit, refund
    
    -- é‡‘é¢
    amount DECIMAL(20, 2) NOT NULL,
    balance_before DECIMAL(20, 2) NOT NULL,
    balance_after DECIMAL(20, 2) NOT NULL,
    
    -- å…³è”
    billing_record_id VARCHAR(64),
    reference_id VARCHAR(64),
    
    -- å…ƒæ•°æ®
    description TEXT,
    metadata JSONB,
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_wallet_created (wallet_id, created_at DESC),
    INDEX idx_user_created (user_id, created_at DESC)
);
```

## ğŸ” äº‹ä»¶æµè¿½è¸ª

### è¿½è¸ª ID é“¾æ¡

```
request_id (ç”¨æˆ·è¯·æ±‚)
    â†“
usage_event_id (ä½¿ç”¨è®°å½•)
    â†“
billing_record_id (è®¡è´¹è®°å½•)
    â†“
transaction_id (é’±åŒ…äº¤æ˜“)
```

### æ—¥å¿—å…³è”æŸ¥è¯¢

```sql
-- æŸ¥è¯¢å®Œæ•´è®¡è´¹é“¾è·¯
SELECT 
    br.billing_record_id,
    br.usage_event_id,
    br.user_id,
    br.product_id,
    br.usage_amount,
    br.cost_usd,
    br.token_equivalent,
    br.status,
    t.transaction_id,
    t.balance_before,
    t.balance_after
FROM billing_records br
LEFT JOIN transactions t ON t.billing_record_id = br.billing_record_id
WHERE br.user_id = 'usr_123'
ORDER BY br.created_at DESC;
```

## ğŸ§ª æµ‹è¯•è¦ç‚¹

### é›†æˆæµ‹è¯•åœºæ™¯

1. **åŸºç¡€è®¡è´¹æµç¨‹**
   - âœ… å‘å¸ƒ usage.recorded â†’ billing.calculated â†’ tokens.deducted
   - âœ… éªŒè¯æ•°æ®åº“è®°å½•
   - âœ… éªŒè¯ä½™é¢å˜åŒ–

2. **å…è´¹å¥—é¤æµ‹è¯•**
   - âœ… ä½¿ç”¨åœ¨å…è´¹é¢åº¦å†…
   - âœ… è¶…å‡ºå…è´¹é¢åº¦åå¼€å§‹æ‰£è´¹

3. **è®¢é˜…åŒ…å«æµ‹è¯•**
   - âœ… ä½¿ç”¨è®¢é˜…åŒ…å«é¢åº¦
   - âœ… è¶…å‡ºè®¢é˜…é¢åº¦åæ‰£è´¹

4. **ä½™é¢ä¸è¶³æµ‹è¯•**
   - âœ… ä½™é¢ä¸è¶³äº‹ä»¶å‘å¸ƒ
   - âœ… é€šçŸ¥å‘é€
   - âœ… è®¡è´¹è®°å½•æ ‡è®°ä¸ºå¤±è´¥

5. **å¤šäº§å“è®¡è´¹**
   - âœ… AI æ¨¡å‹ + MCP å·¥å…· + å­˜å‚¨
   - âœ… ä¸åŒå•ä½è½¬æ¢ä¸º token

6. **å¹¶å‘æµ‹è¯•**
   - âœ… å¤šä¸ªè¯·æ±‚åŒæ—¶æ‰£è´¹
   - âœ… ä½™é¢è®¡ç®—æ­£ç¡®

## ğŸ“ˆ ç›‘æ§æŒ‡æ ‡

### å…³é”®æŒ‡æ ‡

```
- è®¡è´¹äº‹ä»¶å¤„ç†å»¶è¿Ÿ (P50, P95, P99)
- æ‰£è´¹æˆåŠŸç‡
- ä½™é¢ä¸è¶³æ¬¡æ•°
- æ¯æ—¥æ€»æ”¶å…¥
- æŒ‰äº§å“åˆ†ç»„çš„ä½¿ç”¨é‡
- è®¢é˜…è½¬åŒ–ç‡
```

### å‘Šè­¦è§„åˆ™

```
1. è®¡è´¹äº‹ä»¶å¤„ç†å¤±è´¥ç‡ > 1% â†’ å‘Šè­¦
2. æ‰£è´¹å»¶è¿Ÿ > 5s â†’ å‘Šè­¦
3. ä½™é¢ä¸è¶³ç‡ > 10% â†’ é€šçŸ¥è¿è¥
4. å•ç”¨æˆ·å¼‚å¸¸é«˜æ¶ˆè´¹ (>æ—¥å‡ 10x) â†’ é£æ§å‘Šè­¦
```

## ğŸ” å®‰å…¨è€ƒè™‘

### é˜²æ­¢é‡å¤è®¡è´¹

```python
# ä½¿ç”¨ usage_event_id ä½œä¸ºå¹‚ç­‰é”®
SELECT * FROM billing_records 
WHERE usage_event_id = 'evt_789';

IF EXISTS:
    return  # å·²å¤„ç†ï¼Œè·³è¿‡
```

### å¹¶å‘æ§åˆ¶

```python
# é’±åŒ…æ‰£è´¹ä½¿ç”¨ä¹è§‚é”
UPDATE wallets 
SET balance = balance - 300,
    version = version + 1
WHERE wallet_id = 'wal_123'
  AND version = 5  -- å½“å‰ç‰ˆæœ¬
  AND balance >= 300;  -- ç¡®ä¿ä½™é¢å……è¶³

IF affected_rows == 0:
    raise InsufficientBalanceError()
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [äº‹ä»¶é©±åŠ¨æ¶æ„](./event_driven_architecture.md)
- [äº§å“å®šä»·ç­–ç•¥](./product_pricing.md)
- [é’±åŒ…ç³»ç»Ÿè®¾è®¡](./wallet_system.md)
- [è®¢é˜…ç®¡ç†](./subscription_management.md)

---

æœ€åæ›´æ–°: 2025-01-09
ç‰ˆæœ¬: 1.0
