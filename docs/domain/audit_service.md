# Audit Service - Domain Context

## Overview

The Audit Service is the **compliance and security backbone** of the isA_user platform. It provides comprehensive audit trail management, security event monitoring, user activity tracking, and regulatory compliance reporting. Every significant action in the system is captured and stored for accountability, forensic analysis, and regulatory requirements.

**Business Context**: Enable comprehensive audit logging that supports security investigations, regulatory compliance (GDPR, SOX, HIPAA), and operational intelligence. The Audit Service is the central nervous system for tracking "what happened, when, and by whom" across all platform services.

**Core Value Proposition**: Transform distributed service events into a unified, queryable audit trail with real-time security alerting, compliance scoring, and data retention policies that meet global regulatory requirements.

---

## Business Taxonomy

### Core Entities

#### 1. Audit Event
**Definition**: A single record of an action or event that occurred within the platform, captured with full context for compliance and forensic purposes.

**Business Purpose**:
- Establish immutable audit trail for all significant actions
- Enable forensic investigation and security analysis
- Support regulatory compliance evidence collection
- Track system behavior and user activities

**Key Attributes**:
- Event ID (unique identifier)
- Event Type (categorized action type)
- Category (authentication, authorization, data_access, etc.)
- Severity (low, medium, high, critical)
- Status (success, failure, pending, error)
- Action (human-readable action description)
- User ID (actor who performed the action)
- Organization ID (organizational context)
- Resource Type/ID/Name (affected resource)
- IP Address, User Agent (client context)
- Timestamp (when event occurred)
- Metadata (flexible JSONB for additional context)
- Compliance Flags (GDPR, SOX, HIPAA markers)
- Retention Policy (data retention tier)

#### 2. Security Event
**Definition**: A specialized audit event that represents a security-relevant incident requiring attention or investigation.

**Business Purpose**:
- Identify and track security threats
- Enable rapid incident response
- Support threat intelligence gathering
- Maintain security posture visibility

**Key Attributes**:
- Event ID (unique identifier)
- Severity (event criticality)
- Threat Level (low, medium, high, critical)
- Source IP (origin of potential threat)
- Target Resource (attacked resource)
- Attack Vector (method of attack if known)
- Detection Method (how threat was identified)
- Confidence Score (detection certainty 0-1)
- Response Action (mitigation taken)
- Investigation Status (open, investigating, resolved, false_positive)
- Detected At, Resolved At (timestamps)

#### 3. User Activity
**Definition**: A record of user behavior patterns derived from audit events for behavioral analysis and anomaly detection.

**Business Purpose**:
- Track user engagement patterns
- Detect anomalous user behavior
- Support access reviews and attestation
- Enable user experience optimization

**Key Attributes**:
- User ID (user being tracked)
- Activity Type (categorized action)
- Activity Description (human-readable)
- IP Address, User Agent (context)
- Timestamp (when activity occurred)
- Success (whether action succeeded)

#### 4. Compliance Report
**Definition**: A generated report assessing platform compliance with specific regulatory standards over a defined period.

**Business Purpose**:
- Demonstrate regulatory compliance
- Identify compliance gaps and risks
- Support audit preparations
- Enable proactive compliance management

**Key Attributes**:
- Report Type (periodic, ad-hoc, investigation)
- Compliance Standard (GDPR, SOX, HIPAA)
- Period Start/End (reporting timeframe)
- Total Events (events analyzed)
- Compliant Events (events meeting requirements)
- Non-Compliant Events (events with issues)
- Compliance Score (percentage 0-100)
- Findings (detailed issue descriptions)
- Recommendations (remediation guidance)
- Risk Assessment (overall risk evaluation)
- Generated At, Generated By (metadata)

#### 5. User Activity Summary
**Definition**: Aggregated statistics about a user's activity patterns over a specified time period.

**Business Purpose**:
- Provide quick user behavior overview
- Support access certification processes
- Enable risk-based access decisions
- Facilitate user activity reporting

**Key Attributes**:
- User ID (summarized user)
- Total Activities (count of actions)
- Success Count, Failure Count (outcome distribution)
- Last Activity (most recent action timestamp)
- Most Common Activities (top action types)
- Risk Score (calculated user risk 0-100)

---

## Domain Scenarios

### Scenario 1: Real-Time Audit Event Logging
**Actor**: Any Platform Service, API Gateway
**Trigger**: Significant action occurs in any microservice
**Flow**:
1. Service performs operation (e.g., user login, file upload)
2. Service publishes NATS event (e.g., `user.logged_in`, `file.uploaded`)
3. Audit Service receives event via wildcard subscription (`*.*`)
4. Event Handler maps NATS event to audit event type
5. Determines audit category and severity based on event patterns
6. Creates AuditEventCreateRequest with full context
7. Applies compliance policies (retention, flags)
8. Persists audit event to PostgreSQL
9. Triggers real-time analysis for high-severity events
10. Returns confirmation to event bus

**Outcome**: Complete audit trail maintained with automatic compliance tagging

### Scenario 2: Security Alert Creation and Escalation
**Actor**: Security System, Admin, Automated Detection
**Trigger**: Suspicious activity detected (multiple failed logins, unusual access pattern)
**Flow**:
1. Detection system identifies potential threat
2. Calls `POST /api/v1/audit/security/alerts` with threat details
3. Audit Service validates alert request
4. Calculates threat level based on severity
5. Creates SecurityEvent record with investigation status "open"
6. Persists to PostgreSQL security events table
7. Logs warning for high/critical severity events
8. Returns alert ID and threat level to caller
9. (Future: Triggers automated security response workflow)

**Outcome**: Security incident documented, investigation trail started

### Scenario 3: User Activity Investigation
**Actor**: Security Analyst, Compliance Officer
**Trigger**: Need to review specific user's actions for investigation
**Flow**:
1. Analyst queries `GET /api/v1/audit/users/{user_id}/activities?days=90`
2. Audit Service fetches events from PostgreSQL for specified user
3. Filters by time range (last N days)
4. Orders by timestamp descending (most recent first)
5. Converts to JSON-serializable format with ISO timestamps
6. Returns activity list with total count and period
7. Analyst can further drill down with summary endpoint
8. `GET /api/v1/audit/users/{user_id}/summary` provides aggregated stats

**Outcome**: Complete user activity visibility for investigation

### Scenario 4: Compliance Report Generation
**Actor**: Compliance Officer, Automated Scheduler
**Trigger**: Quarterly compliance audit or regulatory request
**Flow**:
1. Officer calls `POST /api/v1/audit/compliance/reports` with standard (GDPR/SOX/HIPAA)
2. Audit Service validates compliance standard is supported
3. Retrieves standard-specific configuration (retention, required fields, sensitive events)
4. Queries audit events within specified period
5. Analyzes each event against compliance requirements:
   - Checks required fields are present
   - Validates sensitive operations have justifications
6. Calculates compliance score (compliant/total * 100)
7. Generates findings list with specific issues
8. Produces recommendations for remediation
9. Assesses overall risk level based on score
10. Returns complete ComplianceReport

**Outcome**: Auditable compliance evidence with actionable findings

### Scenario 5: Audit Event Query with Complex Filters
**Actor**: Admin Dashboard, Analytics Service
**Trigger**: Need to search audit trail with multiple criteria
**Flow**:
1. Dashboard calls `POST /api/v1/audit/events/query` with filters:
   - event_types: [USER_LOGIN, USER_LOGOUT]
   - categories: [AUTHENTICATION]
   - start_time, end_time: date range
   - user_id: specific user (optional)
   - limit: 100, offset: 0
2. Audit Service validates query parameters:
   - Limit cannot exceed 1000
   - Time range cannot exceed 365 days
3. Constructs PostgreSQL query with conditions
4. Executes query with pagination
5. Transforms results to response format
6. Returns events with pagination metadata and applied filters

**Outcome**: Filtered audit data for analysis and reporting

### Scenario 6: Batch Audit Event Logging
**Actor**: Import System, Migration Tool
**Trigger**: Need to log multiple events efficiently
**Flow**:
1. System calls `POST /api/v1/audit/events/batch` with event array (max 100)
2. Audit Service validates batch size limit
3. Iterates through events, calling log_event for each
4. Tracks successful and failed event logs
5. Returns summary: successful_count, failed_count, results array
6. Failed events logged for troubleshooting

**Outcome**: Efficient bulk audit logging with detailed feedback

### Scenario 7: Data Retention Cleanup
**Actor**: Scheduled Job, Admin
**Trigger**: Periodic data cleanup or storage management
**Flow**:
1. Admin calls `POST /api/v1/audit/maintenance/cleanup?retention_days=365`
2. Audit Service calculates cutoff date (now - retention_days)
3. Executes DELETE query for events older than cutoff
4. Returns count of cleaned events and retention configuration
5. Logs cleanup operation completion

**Outcome**: Compliant data retention with storage optimization

### Scenario 8: Service Statistics Retrieval
**Actor**: Monitoring Dashboard, DevOps
**Trigger**: Need real-time audit system health metrics
**Flow**:
1. Dashboard calls `GET /api/v1/audit/stats`
2. Audit Service fetches repository statistics for last 30 days
3. Calculates overall compliance score from success rates
4. Returns ServiceStats with:
   - total_events, events_today
   - active_users, security_alerts
   - compliance_score

**Outcome**: Real-time visibility into audit system health

---

## Domain Events

### Published Events

#### 1. `audit.event_recorded` (EventType.AUDIT_EVENT_RECORDED)
- **When**: Critical audit event is recorded (high/critical severity)
- **Payload**:
  ```json
  {
    "event_id": "audit_uuid",
    "event_type": "security_violation",
    "category": "security",
    "severity": "high",
    "user_id": "user_001",
    "action": "unauthorized_access",
    "success": false,
    "recorded_at": "2025-01-15T10:00:00Z"
  }
  ```
- **Consumers**:
  - `notification_service`: Send security alerts to admins
  - `compliance_service`: Track compliance events
- **Ordering**: Per-event ordering, no strict sequence required
- **Retry**: 3 retries, exponential backoff

### Consumed Events (Wildcard Subscription)

The Audit Service subscribes to ALL events (`*.*`) from all services for comprehensive audit logging.

#### 1. `user.*` from account_service
- **Handler**: `handle_nats_event()` → Maps to authentication/authorization category
- **Examples**: `user.created`, `user.logged_in`, `user.profile_updated`, `user.deleted`
- **Processing**: Maps to EventType.USER_* audit events

#### 2. `payment.*` from payment_service, billing_service
- **Handler**: `handle_nats_event()` → Maps to configuration category
- **Examples**: `payment.completed`, `payment.failed`, `payment.refunded`
- **Processing**: Maps to EventType.RESOURCE_UPDATE

#### 3. `organization.*` from organization_service
- **Handler**: `handle_nats_event()` → Maps to authorization category
- **Examples**: `organization.created`, `organization.member_added`, `organization.member_removed`
- **Processing**: Maps to EventType.ORGANIZATION_*

#### 4. `device.*` from device_service
- **Handler**: `handle_nats_event()` → Maps to data_access category
- **Examples**: `device.registered`, `device.authenticated`, `device.offline`
- **Processing**: Maps to EventType.RESOURCE_*

#### 5. `file.*` from storage_service
- **Handler**: `handle_nats_event()` → Maps to data_access/authorization category
- **Examples**: `file.uploaded`, `file.deleted`, `file.shared`
- **Processing**: Maps to EventType.RESOURCE_* or PERMISSION_GRANT

#### 6. `subscription.*` from subscription_service
- **Handler**: `handle_nats_event()` → Maps to configuration category
- **Examples**: `subscription.created`, `subscription.updated`, `subscription.canceled`
- **Processing**: Maps to EventType.RESOURCE_UPDATE

---

## Core Concepts

### Concept 1: Immutable Audit Trail
Audit events are designed to be immutable once recorded. Unlike other entities in the system, audit events cannot be updated or modified after creation. This ensures the integrity of the audit trail for forensic investigations and regulatory compliance. The only mutation allowed is eventual deletion based on retention policies.

### Concept 2: Compliance-First Design
Every audit event is automatically tagged with compliance flags (GDPR, SOX, HIPAA) based on event type and category. Retention policies are applied automatically based on category:
- Security events: 7 years retention
- Authentication events: 3 years retention
- General events: 1 year retention

### Concept 3: Event-Driven Consumption
The Audit Service uses a wildcard subscription pattern (`*.*`) to capture ALL events from all services. This ensures comprehensive coverage without requiring each service to explicitly integrate with audit logging. The service intelligently maps diverse event types to standardized audit categories.

### Concept 4: Idempotent Event Processing
The service maintains a cache of processed event IDs to prevent duplicate audit entries. When the same event is received multiple times (due to NATS redelivery or system issues), only the first occurrence is recorded. The cache is bounded to prevent memory issues (10,000 entries max).

### Concept 5: Risk-Based Severity Classification
Events are automatically classified by severity based on:
- **Critical**: Security violations, unauthorized access attempts
- **High**: Deletions, permission changes, failed operations
- **Medium**: Updates, shares, member additions
- **Low**: Regular operations, reads, successful actions

### Concept 6: Real-Time Analysis
For high and critical severity events, the Audit Service triggers real-time analysis immediately after logging. This enables rapid detection of:
- Authentication failure patterns (potential brute force)
- Permission escalation attempts
- Unusual resource access patterns

---

## High-Level Business Rules

### Entity Rules (BR-AUD-001 to BR-AUD-010)

**BR-AUD-001: Unique Event ID**
- Every audit event MUST have a unique event_id
- Generated as UUID v4 before persistence
- Error: "AuditError: Duplicate event ID"
- Example: `event_id = uuid.uuid4()`

**BR-AUD-002: Required Action Field**
- Every audit event MUST have a non-empty action field
- Action describes what was done in human-readable form
- Error: "ValidationError: action is required"
- Example: `action = "user_login"`

**BR-AUD-003: Valid Event Type**
- Event type MUST be from EventType enum
- Supported: USER_LOGIN, USER_LOGOUT, USER_REGISTER, USER_UPDATE, USER_DELETE, PERMISSION_*, RESOURCE_*, ORGANIZATION_*, SYSTEM_*, SECURITY_*, COMPLIANCE_CHECK
- Error: "ValidationError: invalid event_type"

**BR-AUD-004: Valid Category**
- Category MUST be from AuditCategory enum
- Supported: AUTHENTICATION, AUTHORIZATION, DATA_ACCESS, CONFIGURATION, SECURITY, COMPLIANCE, SYSTEM
- Error: "ValidationError: invalid category"

**BR-AUD-005: Valid Severity**
- Severity MUST be from EventSeverity enum
- Values: LOW, MEDIUM, HIGH, CRITICAL
- Default: LOW
- Error: "ValidationError: invalid severity"

**BR-AUD-006: Automatic Timestamp**
- Timestamp automatically set to UTC now if not provided
- All timestamps stored in UTC
- Example: `timestamp = datetime.utcnow()`

**BR-AUD-007: Compliance Flag Assignment**
- GDPR flag applied for user deletion/update events
- SOX flag applied for resource/permission updates
- HIPAA flag applied for health-related resource access
- Related Rules: BR-COM-001, BR-COM-002

**BR-AUD-008: Retention Policy Assignment**
- Security category events: 7_years retention
- Authentication category events: 3_years retention
- Other events: 1_year retention
- Applied during event creation

**BR-AUD-009: Valid Status**
- Status MUST be from EventStatus enum
- Values: SUCCESS, FAILURE, PENDING, ERROR
- Default: SUCCESS
- Error: "ValidationError: invalid status"

**BR-AUD-010: Metadata as Valid JSON**
- Metadata field MUST be valid JSON object or null
- Stored as JSONB in PostgreSQL
- Empty object {} is valid
- Error: "ValidationError: invalid metadata format"

### Validation Rules (BR-VAL-001 to BR-VAL-010)

**BR-VAL-001: Query Limit Maximum**
- Query limit MUST NOT exceed 1000 records
- Default: 100
- Error: "查询限制不能超过1000条"
- Example: `limit <= 1000`

**BR-VAL-002: Query Time Range Maximum**
- Query time range MUST NOT exceed 365 days
- Start time MUST be before end time
- Error: "查询时间范围不能超过365天"
- Example: `end_time - start_time <= 365 days`

**BR-VAL-003: Valid Time Order**
- Start time MUST be earlier than end time
- Error: "开始时间必须早于结束时间"
- Example: `start_time < end_time`

**BR-VAL-004: Batch Size Limit**
- Batch event logging MUST NOT exceed 100 events
- Error: "批量事件数量不能超过100"
- Example: `len(events) <= 100`

**BR-VAL-005: Valid Compliance Standard**
- Compliance standard MUST be supported
- Supported: GDPR, SOX, HIPAA
- Error: "不支持的合规标准"
- Related Rules: BR-COM-001

**BR-VAL-006: Security Alert Requires Severity**
- Security alerts MUST specify severity level
- Error: "SecurityAlertError: severity required"

**BR-VAL-007: Days Parameter Bounds**
- Activities days parameter MUST be 1-365
- Error: "ValidationError: days out of range"
- Example: `1 <= days <= 365`

**BR-VAL-008: Valid User ID Format**
- User ID MUST be non-empty string when provided
- System events may use "system" as user_id
- Example: `user_id = "user_001" or "system"`

**BR-VAL-009: Valid IP Address Format**
- IP address SHOULD be valid IPv4 or IPv6 format
- Validation is permissive for legacy data
- Example: `192.168.1.1` or `::1`

**BR-VAL-010: Positive Offset Value**
- Query offset MUST be non-negative
- Default: 0
- Error: "ValidationError: offset must be >= 0"
- Example: `offset >= 0`

### Authorization Rules (BR-AUTH-001 to BR-AUTH-005)

**BR-AUTH-001: Stats Endpoint Authentication**
- `/api/v1/audit/stats` requires authentication
- Public access denied
- Enforced by: API Gateway

**BR-AUTH-002: Event Query Authentication**
- All event query endpoints require authentication
- User must have appropriate role
- Enforced by: API Gateway, JWT validation

**BR-AUTH-003: Security Events Access**
- Security event endpoints require elevated privileges
- Only security roles can create/view security alerts
- Enforced by: Authorization Service

**BR-AUTH-004: Compliance Report Access**
- Compliance report generation requires compliance role
- Report data contains sensitive information
- Enforced by: Authorization Service

**BR-AUTH-005: Maintenance Endpoint Access**
- Cleanup endpoint requires admin privileges
- Data deletion is irreversible
- Enforced by: Authorization Service

### State Transition Rules (BR-STATE-001 to BR-STATE-005)

**BR-STATE-001: Event Immutability**
- Audit events CANNOT be updated after creation
- Only deletion via cleanup is allowed
- Ensures audit trail integrity

**BR-STATE-002: Security Event Investigation Flow**
- Investigation status: open → investigating → resolved/false_positive
- Status can only move forward
- Reopening requires new security event

**BR-STATE-003: Compliance Report States**
- Report status: draft → final → published
- Published reports cannot be modified
- New analysis requires new report

**BR-STATE-004: Retention Policy Application**
- Retention policy applied at creation time
- Cannot be changed after event creation
- Determines cleanup eligibility

**BR-STATE-005: Idempotent Event Processing**
- Same event ID processed only once
- Duplicate events silently ignored
- Cache bounded to 10,000 entries

### Integration Rules (BR-INT-001 to BR-INT-005)

**BR-INT-001: NATS Wildcard Subscription**
- Audit Service subscribes to `*.*` pattern
- Captures ALL service events
- Requires NATS connection on startup

**BR-INT-002: Event Handler Idempotency**
- Processed event IDs cached in memory
- Duplicate NATS messages ignored
- Cache pruned when exceeds 10,000 entries

**BR-INT-003: PostgreSQL Async Operations**
- All database operations are async
- Uses AsyncPostgresClient
- Connection checked on startup

**BR-INT-004: Service Discovery**
- PostgreSQL discovered via ConfigManager
- Falls back to defaults: isa-postgres-grpc:50061
- Environment variables: POSTGRES_HOST, POSTGRES_PORT

**BR-INT-005: Consul Registration**
- Service registers with Consul on startup
- Deregisters on shutdown
- Health check via /health endpoint

---

## Audit Service in the Ecosystem

### Upstream Dependencies
- **PostgreSQL gRPC Service**: Persistent storage for all audit data
- **NATS Event Bus**: Event subscription and consumption
- **Consul**: Service discovery and registration
- **API Gateway**: Request routing and authentication
- **ConfigManager**: Service configuration management

### Downstream Consumers
- **Notification Service**: Receives security alerts for admin notifications
- **Compliance Service**: Consumes compliance-related events
- **Analytics Service**: Queries audit data for behavioral analytics
- **Admin Dashboard**: Displays audit logs and security events

### Integration Patterns
- **Event Subscription**: Wildcard NATS subscription for all service events
- **Synchronous REST**: CRUD operations via FastAPI endpoints
- **Service Discovery**: Consul for dynamic service location
- **Protocol Buffers**: PostgreSQL gRPC communication
- **Health Checks**: `/health` and `/health/detailed` endpoints

### Dependency Injection
- **Repository Pattern**: AuditRepository for data access
- **Protocol Interfaces**: AuditRepositoryProtocol, EventBusProtocol
- **Factory Pattern**: create_audit_service() for production instances
- **Mock-Friendly**: Protocols enable test doubles and mocks

---

## Success Metrics

### Audit Quality Metrics
- **Event Capture Rate**: % of platform events captured (target: 100%)
- **Event Latency**: Time from event occurrence to audit log (target: <500ms)
- **Compliance Score**: Average compliance score across standards (target: >95%)
- **False Positive Rate**: Security alerts marked false_positive (target: <5%)

### Performance Metrics
- **Query Latency**: Time to query audit events (target: <200ms for 100 records)
- **Event Ingestion Rate**: Events logged per second (target: >1000/sec)
- **Report Generation Time**: Time to generate compliance report (target: <30s)
- **Storage Efficiency**: Bytes per audit event (target: <2KB average)

### Availability Metrics
- **Service Uptime**: Audit Service availability (target: 99.99%)
- **Event Bus Connectivity**: NATS subscription health (target: 99.99%)
- **Database Connectivity**: PostgreSQL connection success rate (target: 99.99%)

### Compliance Metrics
- **Retention Compliance**: Events retained per policy (target: 100%)
- **GDPR Completeness**: Events with required GDPR fields (target: >99%)
- **Audit Coverage**: Services with event logging (target: 100%)

---

## Glossary

**Audit Event**: Record of action in the system for accountability
**Audit Trail**: Chronological sequence of audit events
**Compliance Flag**: Marker indicating regulatory relevance (GDPR, SOX, HIPAA)
**Compliance Score**: Percentage of events meeting compliance requirements
**Event Category**: Classification of event type (authentication, authorization, etc.)
**Event Severity**: Criticality level of event (low, medium, high, critical)
**False Positive**: Security alert that was incorrectly triggered
**Idempotent**: Operation producing same result when executed multiple times
**Immutable**: Cannot be changed after creation
**Investigation Status**: Current state of security event investigation
**Retention Policy**: Rules for how long data is kept
**Risk Score**: Calculated risk level for user or event
**Security Event**: Audit event representing potential security threat
**Threat Level**: Assessed danger level of security incident
**User Activity**: Record of user actions for behavioral analysis
**Wildcard Subscription**: NATS subscription pattern matching all events

---

## Summary

| Metric | Count |
|--------|-------|
| Entities | 5 |
| Domain Scenarios | 8 |
| Domain Events | 6+ (1 published, 5+ consumed patterns) |
| Business Rules | 35 |
| Core Concepts | 6 |

---

**Document Version**: 1.0
**Last Updated**: 2025-12-22
**Maintained By**: Audit Service Team
